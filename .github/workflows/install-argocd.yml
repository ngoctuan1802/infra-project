name: Deploy ArgoCD to EKS via Helm

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Cho phép trigger manual từ UI

permissions:
  contents: read
  id-token: write  # Yêu cầu cho OIDC auth

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # (Tùy chọn) Thêm approval gate nếu cần

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::ACCOUNT_ID:role/GitHubActionsEKSRole  # Thay ACCOUNT_ID và role name
        aws-region: us-west-2  # Thay region của EKS cluster

    - name: Setup kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'v1.30.0'  # Phiên bản kubectl khớp với EKS

    - name: Setup Helm
      uses: azure/setup-helm@v4
      with:
        version: 'v3.15.0'  # Phiên bản Helm ổn định mới nhất 2025

    - name: Update kubeconfig for EKS
      run: |
        aws eks update-kubeconfig --region us-west-2 --name my-eks-cluster  # Thay region và cluster name
        kubectl get nodes  # Verify access

    - name: Add ArgoCD Helm repo and update
      run: |
        helm repo add argo https://argoproj.github.io/argo-helm
        helm repo update

    - name: Deploy ArgoCD via Helm with custom values
      run: |
        helm install argocd argo/argo-cd \
          --namespace argocd \
          --create-namespace \
          --version 8.5.9 \  # Phiên bản Helm chart mới nhất
          -f argocd/values.yaml  # Sử dụng file values.yaml từ repo
        echo "✅ ArgoCD deployed successfully via Helm to EKS with custom values!"

    - name: Wait for ArgoCD pods to be ready
      run: |
        kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s

    - name: Get initial admin password
      id: password
      run: |
        PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
        echo "Initial admin password: $PASSWORD"
        echo "password=$PASSWORD" >> $GITHUB_OUTPUT
      shell: bash

    - name: Output login info
      run: |
        echo "To access ArgoCD UI: kubectl port-forward svc/argocd-server -n argocd 8080:443"
        echo "Then open https://localhost:8080 (insecure mode enabled)"
        echo "Username: admin | Password: ${{ steps.password.outputs.password }}"
        echo "Đổi mật khẩu ngay sau khi login!"